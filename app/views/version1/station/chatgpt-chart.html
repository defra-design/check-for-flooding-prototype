<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GOV.UK Prototype — Chart.js from CSV</title>

  <!-- GOV.UK Frontend CSS (prototype-friendly CDN) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/govuk-frontend@4.0.0/govuk-frontend.min.css">

  <style>
    /* Small page tweaks to make the example a little lighter/cleaner */
    body { padding: 2rem; }
    .chart-wrap { max-width: 900px; margin: 0 auto; }
    pre.sample-csv { background:#f3f2f1; padding:1rem; border-radius:4px; overflow:auto }
  </style>
</head>
<body class="govuk-template">

  <header class="govuk-header govuk-header--product" role="banner" data-module="govuk-header">
    <div class="govuk-width-container govuk-header__container">
      <div class="govuk-header__logo">
        <a class="govuk-header__link govuk-header__link--homepage" href="#">GOV.UK Prototype</a>
      </div>
    </div>
  </header>

  <main class="govuk-width-container" id="main-content">
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-two-thirds">
        <h1 class="govuk-heading-xl">Chart.js graph loaded from CSV</h1>
        <p class="govuk-body">This prototype demonstrates a Chart.js line chart that is populated from a CSV file. It supports fetching <code>data.csv</code> on the same host and a file-upload fallback (drag or select a CSV file).</p>

        <section class="govuk-form-group">
          <label class="govuk-label" for="csv-file">Upload a CSV (optional)</label>
          <input class="govuk-file-upload" id="csv-file" name="csv-file" type="file" accept=".csv">
          <p class="govuk-hint">CSV format: first row headers. First column = labels (x axis). Each subsequent column = one dataset.</p>
        </section>

        <div class="chart-wrap">
          <canvas id="chart" aria-label="Data line chart" role="img"></canvas>
        </div>

        
        </div>
    </div>
  </main>

  <footer class="govuk-footer" role="contentinfo">
    <div class="govuk-width-container">
      <div class="govuk-footer__meta">
        <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">
          <h2 class="govuk-visually-hidden">Support links</h2>
          <p class="govuk-footer__meta-heading">Prototype</p>
        </div>
      </div>
    </div>
  </footer>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datasource@0.1.0"></script>

 
  <script>
  // Small CSV parser that handles simple CSVs (no quoted commas) — sufficient for many dataset exports.
  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/).map(l => l.trim());
    const rows = lines.map(line => line.split(','));
    return rows;
  }

  // Build Chart.js data from CSV rows
  function csvRowsToChartData(rows) {
    if (!rows || rows.length < 2) throw new Error('CSV must have at least 2 rows (header + one data row)');

    const headers = rows[0]; // e.g. ["label","Apples","Oranges"]
    const labelCol = headers[0];
    const datasetNames = headers.slice(1);

    const labels = rows.slice(1).map(r => r[0]);
    const datasets = datasetNames.map((name, i) => {
      const data = rows.slice(1).map(r => {
        const v = r[i+1];
        const n = Number(v);
        return isNaN(n) ? null : n;
      });
      return {
        label: name,
        data,
        fill: false,
        tension: 0.3
      };
    });

    return { labels, datasets };
  }

  // Create Chart.js instance (global variable so we can update it)
  let myChart = null;
  const ctx = document.getElementById('chart').getContext('2d');

  function renderChart(data) {
    if (myChart) {
      // update labels and datasets
      myChart.data.labels = data.labels;
      myChart.data.datasets = data.datasets;
      myChart.update();
      return;
    }

    myChart = new Chart(ctx, {
      type: 'line',
      data: data,
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'top' },
          title: { display: true, text: 'CSV-driven line chart' }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }

  // Try fetching data.csv from the same directory
  async function tryFetchCSV() {
    try {
      const resp = await fetch('data.csv', { cache: 'no-cache' });
      if (!resp.ok) throw new Error('No data.csv found');
      const text = await resp.text();
      const rows = parseCSV(text);
      const chartData = csvRowsToChartData(rows);
      renderChart(chartData);
    } catch (err) {
      // If fetch fails, render an empty chart with sample labels so the page still looks OK
      console.warn('Could not fetch data.csv:', err.message);
      const sample = {
        labels: ['Jan','Feb','Mar'],
        datasets: [{ label: 'No data.csv found', data: [0,0,0], fill:false, tension:0.3 }]
      };
      renderChart(sample);
    }
  }

  // Wire up file input to let the user upload a CSV
  document.getElementById('csv-file').addEventListener('change', function (e) {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(ev) {
      try {
        const rows = parseCSV(ev.target.result);
        const chartData = csvRowsToChartData(rows);
        renderChart(chartData);
      } catch (err) {
        alert('Error parsing CSV: ' + err.message);
      }
    };
    reader.readAsText(file);
  });

  // Initial attempt to fetch CSV on load
  tryFetchCSV();
  </script>
</body>
</html>
